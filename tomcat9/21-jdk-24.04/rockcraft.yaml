name: tomcat9

base: bare
build-base: ubuntu@24.04

version: '21-jdk'
summary: Apache Tomcat 9
license: Apache-2.0
description: |
  Apache Tomcat implements the Java Servlet and the JavaServer Pages (JSP)
  specifications from Oracle, and provides a "pure Java" HTTP web
  server environment for Java code to run.
platforms:
    amd64:

services:
  tomcat:
    override: replace
    command: /usr/share/tomcat9/bin/catalina.sh run
    startup: enabled
    environment:
      JAVA_HOME: /usr/lib/jvm/java-21-openjdk-${CRAFT_ARCH_BUILD_FOR}
      CATALINA_BASE: /var/lib/tomcat9

parts:

  tomcat:
    plugin: ant
    build-packages:
      - ant
      - openjdk-17-jdk
    source: https://github.com/apache/tomcat
    source-type: git
    # renovate: datasource=maven depName=org.apache.tomcat:tomcat-catalina
    source-tag: 9.0.109
    ant-build-targets: ["package"]
    ant-properties:
      tomcat.build: ${CRAFT_PART_INSTALL}/var/lib/tomcat9
    override-build: |
      craftctl default
      chown 584792:584792 ${CRAFT_PART_INSTALL}/var/lib/tomcat9/temp
      chown 584792:584792 ${CRAFT_PART_INSTALL}/var/lib/tomcat9/webapps
      chown 584792:584792 ${CRAFT_PART_INSTALL}/var/lib/tomcat9/logs

  deps:
    build-packages:
      - openjdk-21-jdk
    plugin: nil
    source: https://github.com/vpa1977/chisel-releases
    source-type: git
    source-branch: ubuntu-22.04-tomcat9
    override-build: |
      chisel cut --release ./ --root ${CRAFT_PART_INSTALL}/ \
        busybox_bins \
        tomcat9_core \
        libtcnative-1_libs

      chisel cut --release ubuntu-22.04 --root ${CRAFT_PART_INSTALL}/ \
        openjdk-21-jdk-headless_standard \
        media-types_data \
        base-files_bin \
        base-files_chisel
      mkdir -p ${CRAFT_PART_INSTALL}/etc/ssl/certs/java
      cp /etc/ssl/certs/java/cacerts ${CRAFT_PART_INSTALL}/etc/ssl/certs/java/cacerts
      cd ${CRAFT_PART_INSTALL} && \
        ln -sf --relative \
        usr/lib/jvm/java-21-openjdk-${CRAFT_ARCH_BUILD_FOR}/bin/java \
        usr/bin/
      cd ${CRAFT_PART_INSTALL}/bin && for applet in $(./busybox --list); do \
        ln -s busybox $applet ; \
      done
      craftctl default
