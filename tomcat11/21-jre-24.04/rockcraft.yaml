name: tomcat11

base: bare
build-base: ubuntu@24.04

version: '21-jre-24.04'
summary: Apache Tomcat 11
license: Apache-2.0
description: |
  Apache Tomcat implements the Java Servlet and the JavaServer Pages (JSP)
  specifications from Oracle, and provides a "pure Java" HTTP web
  server environment for Java code to run.
platforms:
    amd64:

services:
  tomcat:
    override: replace
    command: /usr/share/tomcat11/bin/catalina.sh run
    startup: enabled
    environment:
      JAVA_HOME: /usr/lib/jvm/java-21-openjdk-${CRAFT_ARCH_BUILD_FOR}
      CATALINA_BASE: /var/lib/tomcat11

parts:
  tomcat:
    plugin: nil
    build-packages:
      - ant
      - openjdk-17-jdk
    source: https://github.com/apache/tomcat
    source-type: git
    # renovate: datasource=maven depName=org.apache.tomcat:tomcat-catalina
    source-tag: 11.0.11
    build-environment:
      - JAVA_HOME: /usr/lib/jvm/java-17-openjdk-${CRAFT_ARCH_BUILD_FOR}/
    override-build: |
      TOMCAT_VERSION=$(git describe --exact-match --tags)
      ant deploy
      # deploy tomcat11
      mkdir -p ${CRAFT_PART_INSTALL}/usr/share/tomcat11
      cp -r output/build/* ${CRAFT_PART_INSTALL}/usr/share/tomcat11/
      # create CATALINA_BASE
      ${CRAFT_PART_INSTALL}/usr/share/tomcat11/bin/makebase.sh \
        ${CRAFT_PART_INSTALL}/var/lib/tomcat11/
      chown -R 584792:584792 ${CRAFT_PART_INSTALL}/var/lib/tomcat11
      # Write dpkg-query statement for "tomcat" package
      # ii ,zlib1g:amd64,1:1.3.dfsg-3.1ubuntu2.1,zlib,1:1.3.dfsg-3.1ubuntu2.1
      echo ii ,tomcat11:${CRAFT_ARCH_BUILD_FOR},${TOMCAT_VERSION}-0,tomcat11,${TOMCAT_VERSION}-0 > ${CRAFT_STAGE}/installed_tomcat.txt
      craftctl default

  # We can not build rock based on a rock
  # copy-paste parts of https://github.com/canonical/jre-rock/tree/channels/21/edge/jre/ubuntu-24.04-headless
  dependencies:
    plugin: nil
    source: https://github.com/vpa1977/chisel-releases
    source-type: git
    source-branch: ubuntu-24.04-tomcat10
    override-build: |
        chisel cut --release ./ --root ${CRAFT_PART_INSTALL}/ \
          busybox_bins \
          libtcnative-1_libs \
          media-types_data \
          base-files_base \
          base-files_chisel \
          libc6_libs \
          libgcc-s1_libs \
          libstdc++6_libs \
          zlib1g_libs \
          libpcsclite1_libs \
          libnss3_libs \

        chroot ${CRAFT_PART_INSTALL}/ /bin/busybox --install
        craftctl default

  runtime:
    plugin: nil
    build-packages:
      - openjdk-21-jdk-headless
    override-build: |
      JAVA_HOME=usr/lib/jvm/java-21-openjdk-${CRAFT_ARCH_BUILD_FOR}
      rm -rf ${CRAFT_PART_INSTALL}/${JAVA_HOME}
      jlink --add-modules java.base,\
      java.compiler,\
      java.instrument,\
      java.logging,\
      java.management,\
      java.management.rmi,\
      java.naming,\
      java.net.http,\
      java.prefs,\
      java.rmi,\
      java.scripting,\
      java.se,\
      java.security.jgss,\
      java.security.sasl,\
      java.smartcardio,\
      java.sql,\
      java.sql.rowset,\
      java.transaction.xa,\
      java.xml,\
      java.xml.crypto,\
      jdk.charsets,\
      jdk.crypto.cryptoki,\
      jdk.crypto.ec,\
      jdk.dynalink,\
      jdk.httpserver,\
      jdk.internal.vm.ci,\
      jdk.internal.vm.compiler,\
      jdk.internal.vm.compiler.management,\
      jdk.jdwp.agent,\
      jdk.jfr,\
      jdk.jsobject,\
      jdk.localedata,\
      jdk.management,\
      jdk.management.agent,\
      jdk.management.jfr,\
      jdk.naming.dns,\
      jdk.naming.rmi,\
      jdk.net,\
      jdk.nio.mapmode,\
      jdk.sctp,\
      jdk.security.auth,\
      jdk.security.jgss,\
      jdk.unsupported,\
      jdk.xml.dom,\
      jdk.zipfs --no-header-files --no-man-pages -G \
      --output ${CRAFT_PART_INSTALL}/${JAVA_HOME}

      cd ${CRAFT_PART_INSTALL}
      mkdir -p usr/bin
      for tool in java jfr jrunscript jwebserver keytool rmiregistry; do
        ln -s --relative ${JAVA_HOME}/bin/${tool} usr/bin/
      done

  security-manifest:
    after:
      - runtime
      - dependencies
      - tomcat
    plugin: nil
    source: .
    build-packages:
      - zstd
      - jq
      # extra tomcat dependencies
      - busybox
      - libtcnative-1
    override-build: |
      mkdir -p $CRAFT_PART_INSTALL/usr/share/rocks/
      FIELDS=(
          '${db:Status-Abbrev}'
          '${binary:Package}'
          '${Version}'
          '${source:Package}'
          '${Source:Version}\n'
        )
      zstd -d -f -q $CRAFT_STAGE/var/lib/chisel/manifest.wall \
        -o $CRAFT_PART_BUILD/manifest

      # add openjdk-21 package
      (
        IFS="," && \
        echo "# os-release" && cat /etc/os-release && echo "# dpkg-query" && \
        dpkg-query -f "${FIELDS[*]}" \
          -W openjdk-21-jdk-headless | head -n 1
      ) > ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query
      cat ${CRAFT_STAGE}/installed_tomcat.txt >> ${CRAFT_PART_INSTALL}/usr/share/rocks/dpkg.query
      # add rest of the packages
      jq -r 'select(.kind == "package") | "\(.name) \(.version)"' \
        $CRAFT_PART_BUILD/manifest | \
        awk -v arch=${CRAFT_ARCH_BUILD_FOR} -F' ' -f print-dpkg-query.awk \
          >> $CRAFT_PART_INSTALL/usr/share/rocks/dpkg.query
      craftctl default
